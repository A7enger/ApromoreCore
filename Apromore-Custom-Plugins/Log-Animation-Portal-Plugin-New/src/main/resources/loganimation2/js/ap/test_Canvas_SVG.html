<!DOCTYPE html>
<!--
  #%L
  This file is part of "Apromore Core".
  %%
  Copyright (C) 2018 - 2020 Apromore Pty Ltd.
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Lesser Public License for more details.
  
  You should have received a copy of the GNU General Lesser Public
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/lgpl-3.0.html>.
  #L%
  -->

<html>
<head>
<style>
    body {
      margin: 0;
    }

    path {
      fill: #eee;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
}
</style>

</head>
<body>
    <!--
    <svg xmlns="http://www.w3.org/2000/svg" width="400" height="200">
        <path id="path1" d="M209.5,160.134c18-2.905,33.225-12.634,42.771-26.634H208h-13 h-48.63c9.419,14,24.13,23.463,41.13,26.515v14.44c-38-5.712-67.083-38.587-67.083-78.288c0-43.723,35.569-79.167,79.292-79.167 s78.979,35.444,78.979,79.167c0,40.278-30.188,73.53-69.188,78.52V160.134z">
        </path>
        <g id="duplicate"></g>
    </svg>
    -->

    <div style="position:relative">
        <svg width="2000" style="background:none;" height="150" style="position:absolute; touch-action: none; user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);" data-element-id="proc_343078594" class="" id="ext-gen187">
            <g class="viewport" transform="matrix(0.6666666865348816,0,0,0.6666666865348816,258.66669475038907,-45.333337227503534)">
                <g class="layer-base" data-element-id="proc_343078594">
                    <g class="djs-group">
                        <g class="djs-element djs-connection" data-element-id="node_63390ae6-64d4-473c-af62-82aea590e270" style="display: block;">
                            <g class="djs-visual">
                                <path d="m  26,199L126,199 " style="fill: none; stroke-width: 2px; stroke: black; stroke-linejoin: round; marker-end: url(&quot;#sequenceflow-end-white-black-a69hfg0zrfk9uh97ywlqsarjj&quot;);"></path>
                            </g>
                            <polyline points="26,199 126,199 " class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;" id="ext-gen213"></polyline>
                            <rect x="20" y="193" width="112" height="12" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-connection" data-element-id="node_4ebf4b29-e890-4ee9-857d-eaee683e3a05" style="display: block;">
                            <g class="djs-visual">
                                <path d="m  906,214L855.884629037176,216.49911258356195 L806,213 " style="fill: none; stroke-width: 2px; stroke: black; stroke-linejoin: round; marker-end: url(&quot;#sequenceflow-end-white-black-a69hfg0zrfk9uh97ywlqsarjj&quot;);"></path>
                            </g>
                            <polyline points="906,214 855.884629037176,216.49911258356195 806,213 " class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></polyline>
                            <rect x="800" y="207" width="112" height="15.499112583561953" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-connection" data-element-id="node_4e12bf4b-719b-4983-b19e-2f5dd5342a77" style="display: block;">
                            <g class="djs-visual">
                                <path d="m  805,179L975,117 " style="fill: none; stroke-width: 2px; stroke: black; stroke-linejoin: round; marker-end: url(&quot;#sequenceflow-end-white-black-a69hfg0zrfk9uh97ywlqsarjj&quot;);"></path>
                            </g>
                            <polyline points="805,179 975,117 " class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></polyline>
                            <rect x="799" y="111" width="182" height="74" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-connection" data-element-id="node_81bdce9e-6e25-483c-9ebe-b9d91a33505a" style="display: block;">
                            <g class="djs-visual">
                                <path d="m  806,204L856.115370962824,201.50088741643805 L906,205 " style="fill: none; stroke-width: 2px; stroke: black; stroke-linejoin: round; marker-end: url(&quot;#sequenceflow-end-white-black-a69hfg0zrfk9uh97ywlqsarjj&quot;);"></path>
                            </g>
                            <polyline points="806,204 856.115370962824,201.50088741643805 906,205 " class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></polyline>
                            <rect x="800" y="195.50088741643805" width="112" height="15.499112583561953" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-connection" data-element-id="node_5c8bcfbb-1493-4daa-9fee-8f341ece6a6c" style="display: block;">
                            <g class="djs-visual">
                                <path d="m  546,204L646,205 " style="fill: none; stroke-width: 2px; stroke: black; stroke-linejoin: round; marker-end: url(&quot;#sequenceflow-end-white-black-a69hfg0zrfk9uh97ywlqsarjj&quot;);"></path>
                            </g>
                            <polyline points="546,204 646,205 " class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></polyline>
                            <rect x="540" y="198" width="112" height="13" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-connection" data-element-id="node_05a88da3-013e-4785-82b0-de676a6aab99" style="display: block;">
                            <g class="djs-visual">
                                <path d="m  286,200L386,201 " style="fill: none; stroke-width: 2px; stroke: black; stroke-linejoin: round; marker-end: url(&quot;#sequenceflow-end-white-black-a69hfg0zrfk9uh97ywlqsarjj&quot;);"></path>
                            </g>
                            <polyline points="286,200 386,201 " class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></polyline>
                            <rect x="280" y="194" width="112" height="13" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_14747264-eccc-4bb3-ac86-a45bc792f43e" style="display: block;" transform="translate(1 187)">
                            <g class="djs-visual">
                                <circle cx="12.5" cy="12.5" r="13" style="stroke: black; stroke-width: 2px; fill: white; fill-opacity: 0.95;"></circle>
                            </g>
                            <rect x="0" y="0" width="25" height="25" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;" id="ext-gen193"></rect>
                            <rect x="-6" y="-6" width="37" height="37" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_14747264-eccc-4bb3-ac86-a45bc792f43e_label" style="display: block;" transform="translate(9 212)">
                            <g class="djs-visual">
                                <text lineHeight="1.2" class="djs-label" style="font-family: Arial, sans-serif; font-size: 11px; font-weight: normal; fill: black;">
                                    <tspan x="0" y="9.899999999999999">|&gt;</tspan>
                                </text>
                            </g>
                            <rect x="0" y="0" width="9" height="14" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;" id="ext-gen194"></rect>
                            <rect x="-6" y="-6" width="21" height="26" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_516c47ee-c01d-40c4-ba47-9e0d2dfa5cb6" style="display: block;" transform="translate(974 101)">
                            <g class="djs-visual">
                                <circle cx="12.5" cy="12.5" r="13" style="stroke: black; stroke-width: 4px; fill: white; fill-opacity: 0.95;"></circle>
                            </g>
                            <rect x="0" y="0" width="25" height="25" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></rect>
                            <rect x="-6" y="-6" width="37" height="37" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_516c47ee-c01d-40c4-ba47-9e0d2dfa5cb6_label" style="display: block;" transform="translate(983 126)">
                            <g class="djs-visual">
                                <text lineHeight="1.2" class="djs-label" style="font-family: Arial, sans-serif; font-size: 11px; font-weight: normal; fill: black;">
                                    <tspan x="0" y="9.899999999999999">[]</tspan>
                                </text>
                            </g>
                            <rect x="0" y="0" width="7" height="14" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></rect>
                            <rect x="-6" y="-6" width="19" height="26" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_9f8a81e1-c06b-4541-978a-705947d398d9" style="display: block;" transform="translate(126 164)">
                            <g class="djs-visual">
                                <rect x="0" y="0" width="160" height="70" rx="10" ry="10" style="stroke: black; stroke-width: 2px; fill: white; fill-opacity: 0.95;"></rect>
                                <text lineHeight="1.2" class="djs-label" style="font-family: Arial, sans-serif; font-size: 12px; font-weight: normal; fill: black;">
                                    <tspan x="76.96875" y="38.6">a</tspan>
                                </text>
                            </g>
                            <rect x="0" y="0" width="160" height="70" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;"></rect>
                            <rect x="-6" y="-6" width="172" height="82" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_9b90facb-05d1-40d5-8fa6-a5ae98e5b840" style="display: block;" transform="translate(386 167)">
                            <g class="djs-visual">
                                <rect x="0" y="0" width="160" height="70" rx="10" ry="10" style="stroke: black; stroke-width: 2px; fill: white; fill-opacity: 0.95;"></rect>
                                <text lineHeight="1.2" class="djs-label" style="font-family: Arial, sans-serif; font-size: 12px; font-weight: normal; fill: black;">
                                    <tspan x="76.6796875" y="38.6">b</tspan>
                                </text>
                            </g>
                            <rect x="0" y="0" width="160" height="70" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;" id="ext-gen204"></rect>
                            <rect x="-6" y="-6" width="172" height="82" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_b838184a-60db-41d1-9291-b622f2dba57f" style="display: block;" transform="translate(646 172)">
                            <g class="djs-visual">
                                <rect x="0" y="0" width="160" height="70" rx="10" ry="10" style="stroke: black; stroke-width: 2px; fill: white; fill-opacity: 0.95;"></rect>
                                <text lineHeight="1.2" class="djs-label" style="font-family: Arial, sans-serif; font-size: 12px; font-weight: normal; fill: black;">
                                    <tspan x="77.2578125" y="38.6">c</tspan>
                                </text>
                            </g>
                            <rect x="0" y="0" width="160" height="70" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;" id="ext-gen212"></rect>
                            <rect x="-6" y="-6" width="172" height="82" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                    <g class="djs-group">
                        <g class="djs-element djs-shape" data-element-id="node_593a40e2-8ca5-4041-b314-fc8a117686a0" style="display: block;" transform="translate(906 176)">
                            <g class="djs-visual">
                                <rect x="0" y="0" width="160" height="70" rx="10" ry="10" style="stroke: black; stroke-width: 2px; fill: white; fill-opacity: 0.95;"></rect>
                                <text lineHeight="1.2" class="djs-label" style="font-family: Arial, sans-serif; font-size: 12px; font-weight: normal; fill: black;">
                                    <tspan x="76.6640625" y="38.6">d</tspan>
                                </text>
                            </g>
                            <rect x="0" y="0" width="160" height="70" class="djs-hit" style="fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;" id="ext-gen209"></rect>
                            <rect x="-6" y="-6" width="172" height="82" class="djs-outline" style="fill: none;"></rect>
                        </g>
                    </g>
                </g>
                <g class="layer-overlays">
                    <g data-element-id="node_63390ae6-64d4-473c-af62-82aea590e270" class="djs-bendpoints">
                        <g class="djs-bendpoint" transform="translate(26 199)">
                            <circle cx="0" cy="0" r="4" class="djs-visual"></circle>
                            <circle cx="0" cy="0" r="10" class="djs-hit" id="ext-gen214"></circle>
                        </g>
                        <g class="djs-bendpoint" transform="translate(126 199)">
                            <circle cx="0" cy="0" r="4" class="djs-visual"></circle>
                            <circle cx="0" cy="0" r="10" class="djs-hit"></circle>
                        </g>
                        <g class="djs-bendpoint floating" transform="translate(44 199)">
                            <circle cx="0" cy="0" r="4" class="djs-visual"></circle>
                            <circle cx="0" cy="0" r="10" class="djs-hit"></circle>
                        </g>
                        <g class="djs-segment-dragger horizontal" transform="translate(76 199)">
                            <g transform="rotate(0)">
                                <rect x="-7" y="-1.5" width="14" height="3" class="djs-visual"></rect>
                                <rect x="-10" y="-4.5" width="20" height="9" class="djs-hit" id="ext-gen215"></rect>
                            </g>
                        </g>
                    </g>
                </g>
                <g class="layer-resizers"></g>
            </g>
            <rect x="-10000" y="10000" width="10" height="10" class="outer-bound-marker" style="fill: none;"></rect>
            <rect x="10000" y="10000" width="10" height="10" class="outer-bound-marker" style="fill: none;"></rect>
            <defs>
                <marker id="sequenceflow-end-white-black-a69hfg0zrfk9uh97ywlqsarjj" viewBox="0 0 20 20" refX="11" refY="10" markerWidth="10" markerHeight="10" orient="auto">
                    <path d="M 1 5 L 11 10 L 1 15 Z" style="fill: black; stroke-width: 1px; stroke-linecap: round; stroke-dasharray: 10000, 1; stroke: black;"></path>
                </marker>
            </defs>
        </svg>

        <canvas style="background:none;position:absolute"></canvas>
    </div>

    <input id="fps" value="5" />
    <button onclick="start();">Start</button>
    <button onclick="paused = !paused">Pause/Unpause</button>
    <button onclick="stop=true;">Stop</button>
    <p id="results">Results:</p>

    <script>
        let svg = document.querySelector("svg");
        let svgBox = svg.getBoundingClientRect();
        let svgG = document.querySelector("svg g");
        let box = svgG.getBoundingClientRect();
        console.log(svgBox);
        let matrix = svgG.transform.baseVal.consolidate().matrix;
        let canvas = document.querySelector("canvas");
        let ctx = canvas.getContext('2d');
        ctx.canvas.width = svgBox.width;
        ctx.canvas.height = svgBox.height;
        //ctx.canvas.x = box.x;
        //ctx.canvas.y = box.y;
        ctx.setTransform(matrix.a, matrix.b, matrix.c, matrix.d, matrix.e, matrix.f);
        //canvas.width = window.innerWidth;
        //canvas.height = window.innerHeight;
        // canvas.x = svg.x;
        // canvas.y = svg.y;

        // Prepare sample data structures
        let paths = [
            'data-element-id=node_4e12bf4b-719b-4983-b19e-2f5dd5342a77',
            'data-element-id=node_5c8bcfbb-1493-4daa-9fee-8f341ece6a6c',
            'data-element-id=node_05a88da3-013e-4785-82b0-de676a6aab99'];
        let pathElements = [];
        let pathElementLengths = [];
        {
            for (let i=0; i<paths.length; i++) {
                let element = document.querySelector('[' + paths[i] + ']' + ' g path');
                pathElements.push(element);
                pathElementLengths.push(element.getTotalLength());
            }
        }

        // Drawing configuration
        let fps = 5;
        let fpsInterval = 1000/fps;
        const distanceIncrease = 0.08;
        let nextDistancePercent = 0;
        const R = 5;
        let stop = false;
        let paused = false;
        let frameCount = 0;
        let startTime, now, then, elapsed;

        function start() {
            // Initialize canvas
            clearCanvas();
            ctx.lineWidth = 0.5;
            ctx.strokeStyle = '#000';
            ctx.fillStyle = "red";

            // Initialize timing
            fps = document.querySelector("#fps").value;
            fpsInterval = 1000/fps;
            frameCount = 0;
            nextDistancePercent = 0;
            then = window.performance.now();
            now = then;
            startTime = then;

            // Start animation
            stop = false;
            pause = false;
            animate();
        }

        function animate(newTime) {
            if (stop) {
                return;
            }
            else if (paused) {
                window.requestAnimationFrame(animate);
                return;
            }

            window.requestAnimationFrame(animate);
            now = newTime;
            elapsed = now - then;
            if (elapsed > fpsInterval) {
                then = now - (elapsed % fpsInterval);

                //Draw
                clearCanvas();
                nextDistancePercent += distanceIncrease;
                if (nextDistancePercent <= 1.0) {
                    for (let i = 0; i < paths.length; i++) {
                        //let point = points[i];
                        ctx.beginPath();
                        let point = pathElements[i].getPointAtLength(pathElementLengths[i] * nextDistancePercent);
                        ctx.arc(point.x, point.y, R, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.stroke();
                    }
                }
                else {
                    //stop = true;
                    nextDistancePercent = 0; //restart
                }

                // Print to check the real FPS
                let sinceStart = now - startTime;
                let currentFps = Math.round(1000 / (sinceStart / ++frameCount) * 100) / 100;
                document.querySelector("#results").innerHTML = "Elapsed time= " + Math.round(sinceStart / 1000 * 100) / 100 + " secs @ " + currentFps + " fps.";
            }


        }

        function clearCanvas() {
            //ctx.save();
            ctx.setTransform(1,0,0,1,0,0);
            ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
            //ctx.restore();
            ctx.setTransform(matrix.a, matrix.b, matrix.c, matrix.d, matrix.e, matrix.f);
        }


        //canvas.addEventListener('mouseover', startDrawingPath, false);
        //canvas.addEventListener('mouseout', pause, false);
    </script>
</body> 
</html>
